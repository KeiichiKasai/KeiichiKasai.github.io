<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>TCPIP协议 | Keiichi&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="定义TCP协议是传输控制协议，即Transmission Control Protocol 基于TCP协议的有HTTP（互联网）、SMTP（邮件）、POP3（邮件）、FTP（文件）、Talent（远程终端接入） 特点 面向字节流 面向连接 全双工通信（双方可互相发送和接受信息） 可靠（三次握手四次挥手） 效率慢（需要三次握手建立连接）  报文段格式TCP协议虽然面向字节流，但是传输的数据单元还是报">
<meta property="og:type" content="article">
<meta property="og:title" content="TCPIP协议">
<meta property="og:url" content="http://example.com/2024/06/25/TCPIP%E5%8D%8F%E8%AE%AE/index.html">
<meta property="og:site_name" content="Keiichi&#39;s blog">
<meta property="og:description" content="定义TCP协议是传输控制协议，即Transmission Control Protocol 基于TCP协议的有HTTP（互联网）、SMTP（邮件）、POP3（邮件）、FTP（文件）、Talent（远程终端接入） 特点 面向字节流 面向连接 全双工通信（双方可互相发送和接受信息） 可靠（三次握手四次挥手） 效率慢（需要三次握手建立连接）  报文段格式TCP协议虽然面向字节流，但是传输的数据单元还是报">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/image/a.png">
<meta property="og:image" content="http://example.com/image/b.png">
<meta property="og:image" content="http://example.com/image/c.png">
<meta property="article:published_time" content="2024-06-25T03:00:10.000Z">
<meta property="article:modified_time" content="2024-08-10T06:04:49.759Z">
<meta property="article:author" content="Keiichi">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/image/a.png">
  
    <link rel="alternate" href="/atom.xml" title="Keiichi's blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Keiichi&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-TCPIP协议" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/06/25/TCPIP%E5%8D%8F%E8%AE%AE/" class="article-date">
  <time class="dt-published" datetime="2024-06-25T03:00:10.000Z" itemprop="datePublished">2024-06-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      TCPIP协议
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>TCP协议是传输控制协议，即Transmission Control Protocol</p>
<p>基于TCP协议的有<code>HTTP（互联网）</code>、<code>SMTP（邮件）</code>、<code>POP3（邮件）</code>、<code>FTP（文件）</code>、<code>Talent（远程终端接入）</code></p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><ul>
<li>面向字节流</li>
<li>面向连接</li>
<li>全双工通信（双方可互相发送和接受信息）</li>
<li>可靠（三次握手四次挥手）</li>
<li>效率慢（需要三次握手建立连接）</li>
</ul>
<h2 id="报文段格式"><a href="#报文段格式" class="headerlink" title="报文段格式"></a>报文段格式</h2><p>TCP协议虽然面向字节流，但是传输的数据单元还是报文<img src="/image/a.png"></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>作用</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>序号</td>
<td>本报文段所发送数据的第一个字节的序号</td>
<td>4字节</td>
</tr>
<tr>
<td>ACK(确认号)</td>
<td>期望收到对方下一个报文段的第一个数据字节的序号</td>
<td>若ACK&#x3D;N，则表明N-1前的数据正确收到</td>
</tr>
<tr>
<td>SYN(同步位)</td>
<td>连接建立时用同步序号</td>
<td>若SYN&#x3D;1,ACK&#x3D;0表示连接请求报文段<br>若SYN&#x3D;1,ACK&#x3D;1表示连接请求响应报文段</td>
</tr>
<tr>
<td>FIN(终止控制位)</td>
<td>释放连接</td>
<td>FIN&#x3D;1表示发送方数据发送完毕，请求释放连接</td>
</tr>
</tbody></table>
<h2 id="建立连接过程"><a href="#建立连接过程" class="headerlink" title="建立连接过程"></a>建立连接过程</h2><h3 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h3><p><img src="/image/b.png"></p>
<ol>
<li>第一次：<code>客户端</code>向<code>服务器</code>发送一个请求连接的报文段（SYN&#x3D;1和一个随机的起始序号seq&#x3D;x）;此时报文段没有携带数据，<code>客户端</code>进入<code>同步已发送</code>状态<br><del>【客户端：兄弟给你发了个x，你看一下】</del></li>
<li>第二次：<code>服务器</code>接受到了<code>客户端</code>发送的报文后，向<code>客户端</code>发送响应报文（SYN&#x3D;1，ACK&#x3D;1）;此时<code>客户端</code><strong>为该TCP连接分配了TCP缓存和变量</strong><br><del>【服务器：收到兄弟，你发的是x吧？我给你x加个1再发给你，然后再随便发你个y，你注意查收】</del></li>
<li>第三次：<code>客户端</code>收到<code>服务器</code>发来的响应报文段后，再向<code>服务器</code>发送连接确认报文段（ACK&#x3D;1）;此时<code>服务端</code><strong>为该TCP连接分配TCP缓存和变量</strong><br><del>【客户端：奈斯兄嘚，知道你收到x还给我加1了，我也收到你发的y了，我也加1给你发过去】</del></li>
<li>已建立一条 TCP 连接，若在此期间未收到对方回复，会重新发送报文</li>
</ol>
<h3 id="为什么要三次握手"><a href="#为什么要三次握手" class="headerlink" title="为什么要三次握手"></a>为什么要三次握手</h3><ul>
<li>第一次握手：客户端发送网络包，服务端收到了。这样服务端就能得出结论：客户端的发送能力、服务端的接收能力是正常的。</li>
<li>第二次握手：服务端发包，客户端收到了。这样客户端就能得出结论：服务端的接收、发送能力，客户端的接收、发送能力是正常的。不过此时服务器并不能确认客户端的接收能力是否正常。</li>
<li>第三次握手：客户端发包，服务端收到了。这样服务端就能得出结论：客户端的接收、发送能力正常，服务器自己的发送、接收能力也正常。</li>
</ul>
<p>因此，需要三次握手才能确认双方的接收与发送能力是否正常。<br>同时也可以防止服务器接收<strong>早已失效的请求</strong>，一直等待客户端的响应，形成死锁，造成资源浪费</p>
<h3 id="为什么不能二次握手"><a href="#为什么不能二次握手" class="headerlink" title="为什么不能二次握手"></a>为什么不能二次握手</h3><p>如客户端发出连接请求，但因连接请求报文丢失而未收到确认，于是客户端再重传一次连接请求。后来收到了确认，建立了连接。数据传输完毕后，就释放了连接，这是正常情况<br>如果客户端共发出了两个连接请求报文段，其中第一个丢失，第二个到达了服务端，但是第一个丢失的报文段只是在某些网络结点长时间滞留了，延误到连接释放以后的某个时间才到达服务端，此时服务端误认为客户端又发出一次新的连接请求，于是就向客户端发出确认报文段，但是发出的确认号和建立连接后的确认号对不上，就会导致客户端会忽略服务端发来的确认请求。但由于是两次握手确认连接，服务端认为已经连接上了，就可以发送数据，但是客户端仍会忽略，造成资源浪费</p>
<h3 id="三次握手可以携带数据吗"><a href="#三次握手可以携带数据吗" class="headerlink" title="三次握手可以携带数据吗"></a>三次握手可以携带数据吗</h3><p>第三次握手的时候，是可以携带数据的。但是，<strong>第一次、第二次握手不可以携带数据</strong></p>
<p>为什么这样呢?大家可以想一个问题，假如第一次握手可以携带数据的话，如果有人要恶意攻击服务器，那他每次都在第一次握手中的 SYN 报文中放入大量的数据。因为攻击者根本就不理服务器的接收、发送能力是否正常，然后疯狂着重复发 SYN 报文的话，这会让服务器花费很多时间、内存空间来接收这些报文。</p>
<p>也就是说，<strong>第一次握手不可以放数据，其中一个简单的原因就是会让服务器更加容易受到攻击了。而对于第三次的话，此时客户端已经处于 ESTABLISHED 状态。对于客户端来说，他已经建立起连接了，并且也已经知道服务器的接收、发送能力是正常的了，所以能携带数据也没啥毛病。</strong></p>
<h2 id="释放连接过程"><a href="#释放连接过程" class="headerlink" title="释放连接过程"></a>释放连接过程</h2><h3 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h3><p><img src="/image/c.png"></p>
<ul>
<li>第一次：<code>客户端</code> 向<code>服务器</code>发送一个连接释放的报文段，并且<code>客户端</code>会停止再发送数据，等待<code>服务器</code>的确认</li>
<li>第二次：<code>服务器</code>收到连接释放报文后，向<code>客户端</code>发送连接释放确认报文段，至此，<code>客户端</code>–&gt;<code>服务器</code>的TCP连接已经断开了，处于半关闭状态</li>
<li>第三次 ：<code>服务器</code>如果已经没有要向<code>客户端</code>发送的数据，就会发送连接释放的报文段，<code>服务器</code>进入最终确认状态</li>
<li>第四次：<code>客户端</code>收到连接释放报文段后，就会向<code>服务器</code>发送连接释放确认的报文段，等待2msl之后<code>客户端</code>关闭，<code>服务器</code>收到之后就关闭。<code>服务器</code>关的比<code>客户端</code>早</li>
</ul>
<h3 id="为什么要四次挥手"><a href="#为什么要四次挥手" class="headerlink" title="为什么要四次挥手"></a>为什么要四次挥手</h3><p>四次挥手是为了保证双方都能通知对方断开连接，也就是释放连接后，双方都不能接收或者发送消息给对方</p>
<p>第一次和第二次挥手，是<code>客户端</code>单方面宣布对<code>服务器</code>断开连接，此时<code>客户端</code>–&gt;<code>服务器</code>的连接断开，但是<code>服务器</code>–&gt;<code>客户端</code>的连接还未断开，TCP连接处于半关闭状态</p>
<p>第三次和第四次挥手，是<code>服务器</code>宣布对<code>客户端</code>断开连接，此时<code>服务器</code>–&gt;<code>客户端</code>的连接断开，第四次挥手后，双方才彻底断开连接</p>
<h3 id="为什么最后要等待2MSL的时间"><a href="#为什么最后要等待2MSL的时间" class="headerlink" title="为什么最后要等待2MSL的时间"></a>为什么最后要等待2MSL的时间</h3><p><code>MSL</code> &#x3D; 最长报文段寿命（<code>Maximum Segment Lifetime</code>）<br>等待2MSL可以保证客户端发送的最后1个连接释放确认报文 、能到达服务器，从而使得服务器能正常释放连接</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/06/25/TCPIP%E5%8D%8F%E8%AE%AE/" data-id="clxu1rpbv0000dc876vrqfb7m" data-title="TCPIP协议" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/06/29/go%E7%AE%97%E6%B3%95%E5%B0%8F%E6%8A%84/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          go算法小抄
        
      </div>
    </a>
  
  
    <a href="/2024/06/23/%E4%B8%80%E4%BA%9B%E6%83%B3%E8%AF%B4%E7%9A%84%E8%AF%9D/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">一些想说的话</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">八月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">七月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">六月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">四月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">二月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">十二月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">十月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">八月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/08/10/%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E5%AD%98%E5%85%A5%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B/">在数据库中存入自定义类型</a>
          </li>
        
          <li>
            <a href="/2024/07/23/Go%E5%9B%BE%E5%BD%A2%E9%AA%8C%E8%AF%81%E7%A0%81%E5%BA%93-base64Chaptcha%E7%9A%84%E4%BD%BF%E7%94%A8/">Go图形验证码库-base64Chaptcha的使用</a>
          </li>
        
          <li>
            <a href="/2024/07/16/%E5%86%8D%E9%81%87%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98/">再遇跨域问题</a>
          </li>
        
          <li>
            <a href="/2024/07/06/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%AC%94%E8%AE%B0/">正则表达式笔记</a>
          </li>
        
          <li>
            <a href="/2024/06/29/go%E7%AE%97%E6%B3%95%E5%B0%8F%E6%8A%84/">go算法小抄</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 Keiichi<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>